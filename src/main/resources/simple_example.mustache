insert into odpp.events
select /*+ MAPJOIN(d1d, d1x, d0d, d0x) */
'ATTR_DPD' as eventTrigger
,t1.key    as dealID 
,t1.key    as eventObject
,null      as amount
,t1.bdate
,t1.branch
  from odpp.deal_tmp2 t1
  join odpp.deal_tmp2 t0 on t0.key = t1.key 
  left join odpp_dict.dpd_bucket d1d on d1d.department = t1.department and t1.dpd between d1d.dpdFrom and coalesce(d1d.dpdTo,t1.dpd) and t1.bdate between d1d.validFrom and d1d.validTo  
  left join odpp_dict.dpd_bucket d1x on d1x.department is null and t1.dpd between d1x.dpdFrom and coalesce(d1x.dpdTo,t1.dpd) and t1.bdate between d1x.validFrom and d1x.validTo  
  left join odpp_dict.dpd_bucket d0d on d0d.department = t0.department and t0.dpd between d0d.dpdFrom and coalesce(d0d.dpdTo,t0.dpd) and t0.bdate between d0d.validFrom and d0d.validTo  
  left join odpp_dict.dpd_bucket d0x on d0x.department is null and t0.dpd between d0x.dpdFrom and coalesce(d0x.dpdTo,t0.dpd) and t0.bdate between d0x.validFrom and d0x.validTo  
 where t1.bdate = DATE'${bdate}' and t1.branch = '${branch}'
   and t0.bdate = DATE'${pbdate}' and t0.branch = '${branch}'
   and coalesce(t1.dpd,0) != coalesce(t0.dpd,0)
   and coalesce(d1d.dpdFrom, d1x.dpdFrom, 0) != coalesce(d0d.dpdFrom, d0x.dpdFrom, 0)
;
