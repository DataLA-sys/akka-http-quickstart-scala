with 
eod as (
select p.branch, p.bdate, max(t.bdate) as last_eom
from (select DATE'${bdate}' as bdate, '${branch}' as branch) as p 
join odpp_dict.clndr_bdate as t on t.branch = p.branch
  and t.bdate > add_months(p.bdate,-2) and t.bdate < p.bdate
  and t.eom
group by p.branch, p.bdate
)
,deal as (
select 
 e.contractID, e.eventid, e.coreSystemRef, e.bdate, e.branch
,max(coalesce(t.bdate,eod.last_eom)) last_bdate
,max(t.bdate) last_bdate2
 from eod
 join odpp_acc.inevent_t e on e.bdate = eod.bdate and e.branch = eod.branch
 left join odpp_acc.inevent_t t on t.branch = eod.branch and t.bdate >= eod.last_eom and t.bdate < eod.bdate and t.contractID = e.contractID
 group by e.contractID, e.eventid, e.coreSystemRef, e.bdate, e.branch
)
,ias as (
select 
 t.contractID, t.eventid, t.coreSystemRef, t.bdate, t.branch
,sum(p.iasinterest) iasSum
from deal t
left join odpp_pwc.outgroupreport p on p.expID = t.contractID and p.branch = t.branch 
  and p.accountingtype='BS'
  and p.bdate >= t.last_bdate
  and p.bdate < t.bdate
group by t.contractID, t.eventid, t.coreSystemRef, t.bdate, t.branch
)
insert overwrite table odpp_acc.incalcmeasure_t partition (bdate, branch)
select
 cast(concat(date_format(bdate,'yyMMdd'),'09000000000') as bigint) + row_number() over(order by contractID) as CalcID
,eventid               as EventID
,contractid            as ContractID
,coreSystemRef         as CoreSystemRef
,bdate                 as CalcDate
,coalesce(iasSum,0)    as IASInterestAccrued
,bdate, branch
from ias t
;
