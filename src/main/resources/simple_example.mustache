with
t0 as (
select
 rc.client_id
,rc.bdate
,rc.branch
,r.rctid        as ATTR_RCT
,r.ir           as ATTR_IRT
,r.wlstat       as ATTR_WLS
,if(substr(upper(r.edu),1,4) = 'IBFS', '1', '') as ATTR_EDU
from odpp.rct_client rc
join odpp.rct r on r.bdate = rc.bdate and r.branch = rc.branch and r.rctid = rc.rct_id and r.clid_rn = 1
where rc.bdate in (DATE'${pbdate}',DATE'${bdate}') and rc.branch = '${branch}' and rc.client_rn = 1
)
,t1 as (
select client_id, bdate, branch, attr, value
from t0 lateral view explode(map('ATTR_RCT', ATTR_RCT, 'ATTR_IRT', ATTR_IRT, 'ATTR_WLS', ATTR_WLS, 'ATTR_EDU', ATTR_EDU)) upv as attr, value
)
insert into odpp.events
select
 c.attr     as eventTrigger
,d.key      as dealID
,d.clientid as eventObject
,null       as amount
,c.bdate
,c.branch
from t1 as c
left join t1 pc on pc.client_id = c.client_id and pc.attr = c.attr and pc.branch = c.branch and pc.bdate = DATE'${pbdate}'
join odpp.deal_tmp2 d on d.clientid = c.client_id and d.branch = c.branch and d.bdate = c.bdate
where c.bdate = DATE'${bdate}'
and coalesce(c.value,'') != coalesce(pc.value, '')
;
