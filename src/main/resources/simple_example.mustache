with 
  deals as (
    select contractid, bdate, branch from odpp_acc.incontract_t where bdate='${bdate}' and branch='${branch}'
    union 
    select creditlineid as contractid, bdate, branch from odpp_acc.increditline_t where bdate='${bdate}' and branch='${branch}'
  )
insert overwrite table odpp_acc.inevent_t partition(bdate='${bdate}', branch='${branch}')
select e.eventid
      ,e.eventtypeid
      ,e.contractid
      ,e.eventdate
      ,e.coresystemref
      ,e.amount
      ,e.cashflowtypeid
      ,e.impairedprincipalportion
      ,e.impairedinterestportion
      ,e.strartprocessing
      ,e.finishprocessing
from deals d 
join odpp.inevent_t_ext e on e.bdate=d.bdate and d.branch=e.branch and e.contractid = d.contractid and e.priority=1
;
