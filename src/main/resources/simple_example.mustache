--Prepayment 'Loan', 'Interbank loan'
with 
 cashflow_today as (
select 
 c.dealid
,sum(c.amount*ex.fixing) amountNE
from odpp.cashflow c
left join odpp.exchangerate as ex on ex.baseccy=c.currency and ex.bdate=c.bdate and ex.counterccy = 'RUB'
where c.bdate = DATE'${bdate}' and c.branch = '${branch}'
  and c.duedate > DATE'${pbdate}' and c.duedate <= c.bdate -- ODPP-805
  and c.typeid in ('1','6') -- principal,annuity  - ODPP-579
group by c.dealID
)
,transactions_today as (
select
 t.bdate, t.branch
,da1.dealID
,d.currency              as dealCCY
,sum(t.amount*ex.fixing) as amountNE
from odpp.transactions t
join odpp.deal_asset_acc_tmp da1 on da1.bdate = t.bdate and da1.branch = t.branch
 and da1.accid = t.creditid
 and da1.productclass in ('Loan', 'Interbank loan')
 and da1.accountingclass = 'Principal'
 and da1.balancene <> 0
join odpp.deal_tmp2 d on d.bdate = da1.bdate and d.branch = da1.branch and d.key = da1.dealid and nullif(t.expid_cr, d.expid) is null 
left join odpp_dict.ga_product g2 on t.bdate between g2.validfrom and g2.validto
 and g2.ga2 = substr(t.debitno, 1, 5)
 and (
 g2.accountingClass in ('Overdue', 'Provision' , 'Cession')
 or g2.accountingClass like 'PL%'
 )
left join odpp.exchangerate as ex on ex.baseccy=t.currency and ex.bdate=t.bdate and ex.counterccy = 'RUB'
where t.bdate = DATE'${bdate}' and t.branch = '${branch}'
  and g2.ga2 is null
  and t.debitid != t.creditid -- ODPP-579, see ticket comments
group by t.bdate, t.branch, da1.dealID, d.currency
)
insert into odpp.events
select
 'PREPAY_Loan'     as eventTrigger
,t.dealid
,t.dealid          as eventObject
,(t.amountNE - coalesce(c.amountNE,0))/ex.fixing as amount
,t.bdate
,t.branch
from transactions_today t
left join cashflow_today c on c.dealid = t.dealid 
left join odpp.exchangerate as ex on ex.baseccy = t.dealCCY and ex.bdate = t.bdate and ex.counterccy = 'RUB'
where 1=1
  and t.amountNE > coalesce(c.amountNE,0)
;


--Prepayment Loan_Cession
with 
 cashflow_today as (
select 
 c.dealid
,sum(c.amount*ex.fixing) amountNE
from odpp.cashflow c
left join odpp.exchangerate as ex on ex.baseccy=c.currency and ex.bdate=c.bdate and ex.counterccy = 'RUB'
where c.bdate = DATE'${bdate}' and c.branch = '${branch}'
  and c.duedate > DATE'${pbdate}' and c.duedate <= c.bdate -- ODPP-805
  and c.typeid in ('1','6') -- principal,annuity  - ODPP-579
group by c.dealID
)
,transactions_today as (
select
 t.bdate, t.branch
,da1.dealID
,d.currency              as dealCCY
,sum(t.amount*ex.fixing) as amountNE
from odpp.transactions t
join odpp.deal_asset_acc_tmp da1 on da1.bdate = t.bdate and da1.branch = t.branch
 and da1.accid = t.creditid
 and da1.productclass in ('Loan_Cession')
 and da1.accountingclass = 'Principal'
 and da1.balancene <> 0
join odpp.deal_tmp2 d on d.bdate = da1.bdate and d.branch = da1.branch and d.key = da1.dealid and nullif(t.expid_cr, d.expid) is null 
join odpp_dict.ga_product g2 on t.bdate between g2.validfrom and g2.validto
 and g2.ga2 = substr(t.debitno, 1, 5)
 and g2.accountingClass in ('Cession', 'Transit')
left join odpp.exchangerate as ex on ex.baseccy=t.currency and ex.bdate=t.bdate and ex.counterccy = 'RUB'
where t.bdate = DATE'${bdate}' and t.branch = '${branch}'
  and t.debitid != t.creditid -- ODPP-579, see ticket comments
group by t.bdate, t.branch, da1.dealID, d.currency
)
insert into odpp.events
select
 'PREPAY_Cession'  as eventTrigger
,t.dealid
,t.dealid          as eventObject
,(t.amountNE - coalesce(c.amountNE,0))/ex.fixing as amount
,t.bdate
,t.branch
from transactions_today t
left join cashflow_today c on c.dealid = t.dealid
left join odpp.exchangerate as ex on ex.baseccy = t.dealCCY and ex.bdate = t.bdate and ex.counterccy = 'RUB'
where 1=1
  and t.amountNE > coalesce(c.amountNE,0)
;


-- Prepayment Interest
with 
 cashflow_today as (
select 
 c.dealid
,sum(c.amount*ex.fixing) as amountNE
from odpp.cashflow c
left join odpp.exchangerate as ex on ex.baseccy=c.currency and ex.bdate=c.bdate and ex.counterccy = 'RUB'
where c.bdate = DATE'${bdate}' and c.branch = '${branch}'
  and c.duedate > DATE'${pbdate}' and c.duedate <= c.bdate -- ODPP-805
  and c.typeid in ('3','6') -- interest,annuity  - ODPP-579
group by c.dealID
)
,transactions_today as (
select 
 t.bdate, t.branch
,da1.dealID
,d.currency              as dealCCY
,sum(t.amount*ex.fixing) as amountNE
from odpp.transactions t
join odpp.deal_asset_acc_tmp da1 on da1.bdate = t.bdate and da1.branch = t.branch
 and da1.accid = t.creditid
 and da1.productclass in ('Loan', 'Loan_Cession', 'Interbank loan' )
 and da1.accountingclass in ('Interest prepayment', 'Interest accrued')
 and (
        (da1.balancene <= 0 and da1.accountingclass = 'Interest accrued') 
        or 
        (da1.balancene >= 0 and da1.accountingclass = 'Interest prepayment')
 )
join odpp.deal_tmp2 d on d.bdate = da1.bdate and d.branch = da1.branch and d.key = da1.dealid and nullif(t.expid_cr, d.expid) is null 
join odpp_dict.ga_product g2 on t.bdate between g2.validfrom and g2.validto
 and g2.ga2 = substr(t.debitno, 1, 5)
 and (
 g2.accountingClass in ('Interest prepayment', 'Interest accrued', 'Provision' , 'Cession', 'Interest overdue')
 or g2.accountingClass like 'PL%'
 )
left join odpp.exchangerate as ex on ex.baseccy=t.currency and ex.bdate=t.bdate and ex.counterccy = 'RUB'
where t.bdate = DATE'${bdate}' and t.branch = '${branch}'   
  and g2.ga2 is null
group by t.bdate, t.branch, da1.dealID, d.currency
)
insert into odpp.events
select
 'PREPAY_Interest' as eventTrigger
,t.dealid
,t.dealid          as eventObject
,(t.amountNE - coalesce(c.amountNE,0))/ex.fixing as amount
,t.bdate
,t.branch
from transactions_today t
left join cashflow_today c on c.dealid = t.dealid
left join odpp.exchangerate as ex on ex.baseccy = t.dealCCY and ex.bdate = t.bdate and ex.counterccy = 'RUB'
where 1=1 
  and t.amountNE > coalesce(c.amountNE,0)
;


-- Deposit
insert into odpp.events
select 
case
when d.maturitydate = t.bdate then 'DEREC_Deposit'
else 'PREPAY_Deposit'
end                as eventTrigger
,da1.dealID 
,da1.dealID        as eventObject
,sum(t.amount)
,t.bdate
,t.branch
from odpp.transactions t 
join odpp.deal_asset_acc_tmp da1 on da1.bdate = t.bdate and da1.branch = t.branch
  and da1.accid = t.debitid 
  and da1.productClass in ('Interbank deposit', 'Deposit')
  and da1.accountingClass = 'Principal'
  and da1.balance != 0
join odpp.deal_tmp2 d on d.bdate = da1.bdate and d.branch = da1.branch and d.key = da1.dealid and nullif(t.expid_db, d.expid) is null
left join odpp_dict.ga_product g2 on t.bdate between g2.validfrom and g2.validto
  and g2.ga2 = substr(t.creditno, 1, 5)
  and g2.accountingClass like 'PL%'
where t.bdate = DATE'${bdate}' and t.branch = '${branch}'
  and g2.ga2 is null
  and d.maturitydate < t.bdate
group by t.bdate, t.branch, da1.dealID, d.maturitydate
;
