-- RestructuringNotcomm: Реструктуризация задолженности, связанная с изменением кредитного риска
insert into odpp.events
select 
'RESTRU_NOT_COM'    as eventTrigger
,d.key              as dealID
,d.key              as eventObject
,null               as amount
,d.bdate
,d.branch 
from odpp.deal_tmp2 d
join odpp.account_tmp acc on (d.mainaccountid = acc.key and acc.bdate = d.bdate and acc.branch = d.branch)
join odpp_dict.ga_product ga on (substring(acc.accountno,1,5) = ga.ga2 and d.bdate between ga.validfrom and ga.validto)
  where 1=1
  and d.bdate = '${bdate}'
  and d.branch = '${branch}'
  and d.forbearancedate = d.bdate
  and ga.productclass in ('Loan','Loan_Cession')
;


-- RestructuringComm: Реструктуризация задолженности, не связанная с изменением кредитного риска
insert into odpp.events
select 
'RESTRU_COM'    as eventTrigger
,d.key          as dealID
,d.key          as eventObject
,null           as amount
,d.bdate
,d.branch
from odpp.deal_ekpp_tmp de 
join odpp.deal_tmp2 d        on d.key = de.dealid and d.bdate = de.bdate and d.branch = de.branch
join odpp.account_tmp acc    on (d.mainaccountid = acc.key and acc.bdate = d.bdate and acc.branch = d.branch)
join odpp_dict.ga_product ga on (substring(acc.accountno,1,5) = ga.ga2 and d.bdate between ga.validfrom and ga.validto)
join odpp.deal_ekpp_tmp pde  on pde.dealid = d.key and pde.bdate = DATE'${pbdate}' and pde.branch = d.branch
  where 1=1
  and de.bdate = '${bdate}'
  and de.branch = '${branch}'
  and d.datarestru = de.bdate
  and ga.productclass in ('Loan','Loan_Cession')
  and de.isstraightline = pde.isstraightline
;


-- RestructuringCommChangeCalc: Реструктуризация задолженности, не связанная с изменением кредитного риска (переход с линейного метода на ЭПС)
insert into odpp.events
select 
'RESTRU_COM_CC'    as eventTrigger
,d.key          as dealID
,d.key          as eventObject
,null           as amount
,d.bdate
,d.branch
from odpp.deal_ekpp_tmp de 
join odpp.deal_tmp2 d on (de.dealid = d.key and de.bdate = d.bdate and de.branch = d.branch)
join odpp.account_tmp acc on (d.mainaccountid = acc.key and acc.bdate = d.bdate and acc.branch = d.branch)
join odpp_dict.ga_product ga on (substring(acc.accountno,1,5) = ga.ga2 and d.bdate between ga.validfrom and ga.validto)
join odpp.deal_ekpp_tmp pde  on pde.dealid = d.key and pde.bdate = DATE'${pbdate}' and pde.branch = d.branch
  where 1=1
  and de.bdate = '${bdate}'
  and de.branch = '${branch}'
  and d.datarestru = de.bdate
  and ga.productclass in ('Loan','Loan_Cession')
  and pde.isstraightline = '1'
  and de.isstraightline != '1'
;
