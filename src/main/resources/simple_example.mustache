with 
t0 as (
select 
 t.key as deal_id, t.bdate, t.branch
,t.productid        as attr_prod
,t.isuncommitted    as attr_ucmt
,coalesce(t.productcodedevl,'') as attr_cdevel
from odpp.deal_tmp2 t
where bdate in (DATE'${bdate}',DATE'${pbdate}') and branch = '${branch}'
)
,t1 as (
select deal_id, bdate, branch, attr, value 
from t0 lateral view explode(map('ATTR_PROD', ATTR_PROD, 'ATTR_UCMT', ATTR_UCMT, 'ATTR_CDEVEL', ATTR_CDEVEL)) upv as attr, value
)
insert into odpp.events
select 
 d.attr     as eventTrigger
,d.deal_id  as dealID 
,d.deal_id  as eventObject
,null       as amount
,d.bdate
,d.branch
from t1 d
join t1 pd on pd.deal_id = d.deal_id and pd.attr = d.attr and pd.branch = d.branch and pd.bdate = DATE'${pbdate}'
where d.bdate = DATE'${bdate}'
  and d.value != pd.value
;

with 
t0 as (
select 
 t.key as deal_id, t.bdate, t.branch
,coalesce(t.grossbookvalue,0)       as attr_gb
,coalesce(t.balanceequivalent,0)    as attr_be
from odpp.deal_tmp2 t
where bdate in (DATE'${bdate}',DATE'${pbdate}') and branch = '${branch}'
)
,t1 as (
select deal_id, bdate, branch, attr, value 
from t0 lateral view explode(map('ATTR_GB', ATTR_GB, 'ATTR_BE', ATTR_BE)) upv as attr, value
)
insert into odpp.events
select 
 d.attr     as eventTrigger
,d.deal_id  as dealID 
,d.deal_id  as eventObject
,null       as amount
,d.bdate
,d.branch
from t1 d
left join t1 pd on pd.deal_id = d.deal_id and pd.attr = d.attr and pd.branch = d.branch and pd.bdate = DATE'${pbdate}'
where d.bdate = DATE'${bdate}'
  and d.value != coalesce(pd.value,0)
;
