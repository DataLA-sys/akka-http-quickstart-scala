insert overwrite table odpp_acc.inaccount_t partition(bdate='${bdate}', branch='${branch}')
select 
 a.key
,a.sourceaccountid  as AccountID
,t.contractID       as ContractID
,a.accountno        as AccountReference
,a.description      as AccountDescription
,if(a.branch='0000', 1, 2)   as CoreSystemRef
,case
  when a.branch = '0000' then cast(null as string)
  else substr(a.sourceaccountid, 1, 4)
end as BISAB
,case
  when a.branch = '0000' then cast(null as string)
  else substr(a.sourceaccountid, 5, 6)
end as BISAN
,case
  when a.branch = '0000' then cast(null as string)
  else substr(a.sourceaccountid, 11, 3)
end as BISAS
,case
  when a.branch = '0000' then cast(null as string)
  else a.sourceaccountid
end as InternalSystemAccountID 
,case
  when a.branch = '0000' then cast(null as string)
  else a.activetype
end as InternalSystemAccountTypeID
,case
  when a.currency = 'RUR' then 'RUB'
  else a.currency
end as Currency
,substr(a.accountno, 0, 5) as Account5
from odpp_acc.inevent_t t
join odpp.deal_tmp2 d on d.bdate = t.bdate and d.branch = t.branch and d.srcDealID = t.contractID
join odpp.deal_asset_acc_tmp da on da.bdate = d.bdate and da.branch = d.branch and da.dealid = d.key
join odpp.account_tmp a on a.bdate = da.bdate and a.branch = da.branch and a.key = da.accid
where 1 = 1
  and t.branch = '${branch}' and t.bdate = '${bdate}'
;
