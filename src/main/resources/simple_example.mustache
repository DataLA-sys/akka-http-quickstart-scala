insert into odpp.events
select 'ATTR_DEFBUC'	   eventTrigger
       ,DEF_DEALS_B.dealid dealid
       ,DEF_DEALS_B.dealid eventobject
       ,null               amount
       ,DATE '${bdate}'	   bdate
       ,'${branch}'		   branch
from
  (
	select DDT.dealid,
		   DB.id default_bucket_id
	from odpp.default_deal DDT
	   join odpp_dict.default_bucket DB
	      on datediff(DDT.bdate, DDT.dflt_cl_dt) BETWEEN DB.day_from and nvl(DB.day_to, datediff(DDT.bdate, DDT.dflt_cl_dt))
   	     and DDT.bdate between DB.validFrom and DB.validTo
	where DDT.bdate = DATE '${bdate}'
	  and DDT.branch = '${branch}'
  ) DEF_DEALS_B
  join
  (
	select DDT.dealid,
		   DB.id default_bucket_id
	from odpp.default_deal DDT
	   join odpp_dict.default_bucket DB
	      on datediff(DDT.bdate, DDT.dflt_cl_dt) BETWEEN DB.day_from and nvl(DB.day_to, datediff(DDT.bdate, DDT.dflt_cl_dt))
	     and DDT.bdate between DB.validFrom and DB.validTo
	where DDT.bdate = DATE '${pbdate}'
	  and DDT.branch = '${branch}'
   ) DEF_DEALS_P
     on DEF_DEALS_B.dealid = DEF_DEALS_P.dealid
where DEF_DEALS_B.default_bucket_id != DEF_DEALS_P.default_bucket_id
;
