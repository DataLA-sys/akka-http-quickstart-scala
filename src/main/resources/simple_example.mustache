with
t1 as (
select 
 concat(cm.euabd,cm.euand,cm.euasd,cm.eudt1d) as expID
,sum(ct.eumsu)                                as allocatedValue
,cm.bdate    
,cm.branch
 from odpp_bis.seuddy cm
 join odpp_bis.seuy ct on ct.bdate = cm.bdate and ct.branch = cm.branch and ct.euabo = cm.euabo and ct.euano = cm.euano and ct.euaso = cm.euaso
 join odpp.account_tmp a on a.bdate = cm.bdate and a.branch = cm.branch and a.sourceaccountid = concat(cm.euabo,cm.euano,cm.euaso) and a.activetype in ('RC','RE','RI')
where cm.bdate = '${bdate}' and cm.branch = '${branch}'
group by cm.bdate, cm.branch, cm.euabd,cm.euand,cm.euasd,cm.eudt1d
)
,t0 as (
select 
 concat(cm.euabd,cm.euand,cm.euasd,cm.eudt1d) as expID
,sum(ct.eumsu)                                as allocatedValue
,cm.bdate    
,cm.branch
 from odpp_bis.seuddy cm
 join odpp_bis.seuy ct on ct.bdate = cm.bdate and ct.branch = cm.branch and ct.euabo = cm.euabo and ct.euano = cm.euano and ct.euaso = cm.euaso
 join odpp.account_tmp a on a.bdate = cm.bdate and a.branch = cm.branch and a.sourceaccountid = concat(cm.euabo,cm.euano,cm.euaso) and a.activetype in ('RC','RE','RI')
where cm.bdate = '${pbdate}' and cm.branch = '${branch}'
group by cm.bdate, cm.branch, cm.euabd,cm.euand,cm.euasd,cm.eudt1d
)
,tx as (
select coalesce(t1.expID, t0.expID) expID
  from t1
  full outer join t0 on t1.expID = t0.expID
 where coalesce(t1.allocatedValue,0) != coalesce(t0.allocatedValue,0)
)
insert into odpp.events
select 
'ATTR_CLTL'  as eventTrigger
,d.key       as dealID
,d.key       as eventObject
,null        as amount
,d.bdate
,d.branch
  from tx
  join odpp.deal_tmp2 d on d.expid = tx.expid and d.bdate = '${bdate}' and d.branch = '${branch}' and d.descproductcodedevl like '%MORTGAGE%'
;
